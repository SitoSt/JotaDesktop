---
import "../../styles/chat.css";
import MessageItem from "./MessageItem.astro";

const apiUrl =
    import.meta.env.JOTA_API_URL || "http://green-house.local/api/jota";
const initialUserId = import.meta.env.JOTA_USER_ID || "";
---

<div
    class="chat-container"
    data-api-url={apiUrl}
    data-initial-user-id={initialUserId}
>
    <div id="chat-messages" class="messages">
        <!-- Initial/History messages could be rendered here using MessageItem if passed via props -->
    </div>
    <div class="input-area">
        <input
            type="text"
            id="chat-input"
            placeholder="Type a message..."
            autocomplete="off"
        />
        <button id="send-btn">Send</button>
    </div>
</div>

<script>
    import { JotaService } from "../../services/jotaService";
    import { marked } from "marked";

    // State
    let service: JotaService;
    let currentMessageDiv: HTMLDivElement | null = null;
    let isTyping = false;
    let typingIndicator: HTMLDivElement | null = null;

    // Get configuration from DOM data attributes
    const container = document.querySelector(".chat-container") as HTMLElement;
    const apiUrl =
        container.dataset.apiUrl || "http://green-house.local/api/jota";
    const initialUserId = container.dataset.initialUserId || "";

    // Resolve User ID: Env Var -> LocalStorage -> Random
    let userId = initialUserId || localStorage.getItem("jota_user_id");

    // DOM Elements
    const messagesDiv = document.getElementById(
        "chat-messages",
    ) as HTMLDivElement;
    const input = document.getElementById("chat-input") as HTMLInputElement;
    const sendBtn = document.getElementById("send-btn") as HTMLButtonElement;

    // Initialize or retrieve User ID
    if (!userId) {
        userId = "user_" + Math.floor(Math.random() * 1000);
        localStorage.setItem("jota_user_id", userId);
    }

    function init() {
        // Convert HTTP URL to WS URL if needed, or JotaService handles it?
        // JotaService expects "ws://...".
        // If JOTA_API_URL is "http://...", we need to replace protocol.
        const wsUrl = apiUrl.replace(/^http/, "ws");

        service = new JotaService(userId!, wsUrl);

        service.setCallbacks({
            onOpen: () => {
                appendSystemMessage("Connected to Jota");
            },
            onToken: (token) => {
                removeTypingIndicator();
                const targetDiv = currentMessageDiv || startBotMessage();

                // Store raw text in data attribute to accumulate stream
                const rawText = (targetDiv.dataset.raw || "") + token;
                targetDiv.dataset.raw = rawText;

                // Parse markdown synchronously
                const rendered = marked.parse(rawText, { async: false });
                if (typeof rendered === "string") {
                    targetDiv.innerHTML = rendered;
                } else {
                    // If promise (unlikely with default settings but possible)
                    (rendered as Promise<string>).then(
                        (html) => (targetDiv.innerHTML = html),
                    );
                }

                scrollToBottom();
            },
            onError: (error) => {
                console.error("JotaService Error:", error);
                removeTypingIndicator();
            },
            onClose: () => {
                removeTypingIndicator();
                appendSystemMessage(
                    "Connection lost. Attempting to reconnect...",
                );
            },
        });

        service.connect();

        // Event Listeners
        sendBtn.addEventListener("click", sendMessage);
        input.addEventListener("keypress", (e) => {
            if (e.key === "Enter") sendMessage();
        });
    }

    function sendMessage() {
        const text = input.value.trim();
        if (!text) return;

        appendUserMessage(text);
        service.sendMessage(text);
        input.value = "";
        currentMessageDiv = null; // Reset for next bot response
        showTypingIndicator();
    }

    function appendUserMessage(text: string) {
        const div = document.createElement("div");
        div.className = "message user";
        div.textContent = text;
        messagesDiv.appendChild(div);
        scrollToBottom();
    }

    function startBotMessage(): HTMLDivElement {
        const div = document.createElement("div");
        div.className = "message bot";
        div.dataset.raw = ""; // Initialize raw text buffer
        messagesDiv.appendChild(div);
        currentMessageDiv = div;
        scrollToBottom();
        return div;
    }

    function appendSystemMessage(text: string) {
        const div = document.createElement("div");
        div.className = "message system";
        div.textContent = text;
        messagesDiv.appendChild(div);
        scrollToBottom();
    }

    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function showTypingIndicator() {
        if (typingIndicator) return;
        isTyping = true;
        typingIndicator = document.createElement("div");
        typingIndicator.className = "message bot typing-indicator";
        typingIndicator.textContent = "Typing...";
        messagesDiv.appendChild(typingIndicator);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        if (typingIndicator) {
            typingIndicator.remove();
            typingIndicator = null;
        }
        isTyping = false;
    }

    // Start
    init();
</script>
